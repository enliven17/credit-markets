"use client";`n`nimport { CountdownTimer } from "@/components/market/countdown-timer";`nimport { Badge } from "@/components/ui/badge";`nimport { Button } from "@/components/ui/button";`nimport { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";`nimport { Input } from "@/components/ui/input";`nimport {`n  Select,`n  SelectContent,`n  SelectItem,`n  SelectTrigger,`n  SelectValue`n} from "@/components/ui/select";`nimport {`n  getAllMarkets`n} from "@/lib/flow-wager-scripts";`nimport flowConfig from "@/lib/flow/config";`nimport { useAuth } from "@/providers/auth-provider";`nimport type { Market, Position } from "@/types/market";`nimport * as fcl from "@onflow/fcl";`nimport {`n  AlertTriangle,`n  ArrowUpDown,`n  Calendar,`n  ExternalLink,`n  MoreHorizontal,`n  RefreshCw,`n  Search,`n  Target,`n  TrendingDown,`n  TrendingUp`n} from "lucide-react";`nimport Link from "next/link";`nimport { useEffect, useState } from "react";`nimport { toast } from "sonner";`n`n// Enhanced Position interface to match Flow contract data`ninterface FlowPosition extends Position {`n  marketTitle?: string;`n  marketCategory?: string;`n  marketEndTime?: string;`n  marketStatus?: string;`n  optionAName?: string;`n  optionBName?: string;`n}`n`n// Flow script to get user positions (placeholder - positions tracking needs to be implemented in contract)`nconst GET_USER_POSITIONS = ``n  import Credit Predict from 0x${process.env.NEXT_PUBLIC_Credit Predict_TESTNET_CONTRACT?.replace(`n    "0x",`n    ""`n  )}`n  `n  access(all) fun main(userAddress: Address): [AnyStruct] {`n    // NOTE: User position tracking is not yet implemented in the Credit Predict contract`n    // This would need to be added to track individual user positions across markets`n    // For now, return empty array`n    return []`n  }`n`;`n`ninterface PositionsTableProps {`n  positions?: FlowPosition[];`n  isLoading?: boolean;`n  compact?: boolean;`n  userAddress?: string;`n}`n`nexport function PositionsTable({ `n  positions: propPositions,`n  isLoading: propIsLoading = false,`n  compact = false,`n  userAddress`n}: PositionsTableProps) {`n  const { user, isAuthenticated } = useAuth();`n  const [positions, setPositions] = useState<FlowPosition[]>([]);`n  const [markets, setMarkets] = useState<Market[]>([]);`n  const [isLoading, setIsLoading] = useState(propIsLoading);`n  const [error, setError] = useState<string | null>(null);`n  const [searchQuery, setSearchQuery] = useState("");`n  const [sortBy, setSortBy] = useState<"pnl" | "value" | "created" | "market">("pnl");`n  const [sortOrder, setSortOrder] = useState<"asc" | "desc">("desc");`n  const [filterSide, setFilterSide] = useState<"all" | "optionA" | "optionB">("all");`n  const [lastRefresh, setLastRefresh] = useState<number>(Date.now());`n`n  // Use provided positions or fetch from contract`n  const targetUserAddress = userAddress || user?.addr;`n`n  // Initialize Flow configuration`n  const initConfig = async () => {`n    try {`n      flowConfig();`n    } catch (error) {`n      console.error("Failed to initialize Flow config:", error);`n    }`n  };`n`n  // Fetch markets data to enrich positions`n  const fetchMarkets = async () => {`n    try {`n      await initConfig();`n      `n      const allMarketsScript = await getAllMarkets();`n      const marketData = await fcl.query({`n        cadence: allMarketsScript,`n      });`n`n      console.log("Fetched markets for positions:", marketData);`n      `n      // Transform market data`n      const transformedMarkets: Market[] = marketData?.map((market: any) => ({`n        id: market.id.toString(),`n        title: market.title,`n        description: market.description,`n        category: parseInt(market.category.rawValue),`n        optionA: market.optionA,`n        optionB: market.optionB,`n        creator: market.creator,`n        createdAt: market.createdAt.toString(),`n        endTime: market.endTime.toString(),`n        minBet: market.minBet.toString(),`n        maxBet: market.maxBet.toString(),`n        status: parseInt(market.status.rawValue),`n        outcome: market.outcome ? parseInt(market.outcome.rawValue) : undefined,`n        resolved: market.resolved,`n        totalOptionAShares: market.totalOptionAShares.toString(),`n        totalOptionBShares: market.totalOptionBShares.toString(),`n        totalPool: market.totalPool.toString(),`n      })) || [];`n`n      setMarkets(transformedMarkets);`n      return transformedMarkets;`n    } catch (error) {`n      console.error("Failed to fetch markets:", error);`n      setError("Failed to load market data");`n      return [];`n    }`n  };`n`n  // Fetch user positions from Flow contract`n  const fetchPositions = async () => {`n    if (!targetUserAddress) {`n      setPositions([]);`n      return;`n    }`n`n    try {`n      setError(null);`n      await initConfig();`n`n      // Fetch user positions (currently returns empty array since not implemented)`n      const userPositions = await fcl.query({`n        cadence: GET_USER_POSITIONS,`n        args: (arg, t) => [arg(targetUserAddress, t.Address)],`n      });`n`n      console.log("User positions from contract:", userPositions);`n`n      // Since position tracking is not yet implemented in the contract,`n      // we'll return empty array and show appropriate message`n      setPositions([]);`n      `n    } catch (error) {`n      console.error("Failed to fetch positions:", error);`n      setError("Failed to load positions from contract");`n      setPositions([]);`n      toast.error("Failed to load positions");`n    }`n  };`n`n  // Enhanced refresh function`n  const handleRefresh = async () => {`n    setIsLoading(true);`n    try {`n      await Promise.all([`n        fetchMarkets(),`n        fetchPositions()`n      ]);`n      setLastRefresh(Date.now());`n      toast.success("Positions refreshed");`n    } catch (error) {`n      console.error("Refresh failed:", error);`n      toast.error("Failed to refresh positions");`n    } finally {`n      setIsLoading(false);`n    }`n  };`n`n  // Fetch data on mount or when user/userAddress changes`n  useEffect(() => {`n    const loadData = async () => {`n      if (propPositions) {`n        setPositions(propPositions);`n        setIsLoading(false);`n        return;`n      }`n`n      setIsLoading(true);`n      try {`n        await Promise.all([`n          fetchMarkets(),`n          fetchPositions()`n        ]);`n      } finally {`n        setIsLoading(false);`n      }`n    };`n`n    loadData();`n  }, [targetUserAddress, propPositions]);`n`n  // Enhanced position filtering and sorting`n  const filteredPositions = positions`n    .filter(position => {`n      // Find associated market data`n      const market = markets.find(m => m.id === position.marketId?.toString());`n      `n      const matchesSearch = !searchQuery || `n        market?.title.toLowerCase().includes(searchQuery.toLowerCase()) ||`n        position.marketTitle?.toLowerCase().includes(searchQuery.toLowerCase()) ||`n        market?.description.toLowerCase().includes(searchQuery.toLowerCase());`n      `n      const matchesSide = filterSide === "all" || position.side === filterSide;`n      return matchesSearch && matchesSide;`n    })`n    .sort((a, b) => {`n      let aValue: number;`n      let bValue: number;`n`n      switch (sortBy) {`n        case "pnl":`n          aValue = a.pnl;`n          bValue = b.pnl;`n          break;`n        case "value":`n          aValue = a.currentValue;`n          bValue = b.currentValue;`n          break;`n        case "created":`n          aValue = a.createdAt;`n          bValue = b.createdAt;`n          break;`n        case "market":`n          const marketA = markets.find(m => m.id === a.marketId?.toString());`n          const marketB = markets.find(m => m.id === b.marketId?.toString());`n          return sortOrder === "desc" `n            ? (marketB?.title || "").localeCompare(marketA?.title || "")`n            : (marketA?.title || "").localeCompare(marketB?.title || "");`n        default:`n          return 0;`n      }`n`n      return sortOrder === "desc" ? bValue - aValue : aValue - bValue;`n    });`n`n  const formatCurrency = (value: number) => {`n    if (isNaN(value)) return "0.00 tCTC";`n    return `${value.toFixed(2)} tCTC`;`n  };`n`n  const formatShares = (shares: number) => {`n    if (isNaN(shares)) return "0.00";`n    return shares.toFixed(2);`n  };`n`n  const getPnlColor = (pnl: number) => {`n    if (pnl > 0) return "text-green-400";`n    if (pnl < 0) return "text-red-400";`n    return "text-gray-400";`n  };`n`n  const getPnlIcon = (pnl: number) => {`n    if (pnl > 0) return <TrendingUp className="h-4 w-4" />;`n    if (pnl < 0) return <TrendingDown className="h-4 w-4" />;`n    return null;`n  };`n`n  const getMarketStatus = (market: Market) => {`n    const now = Date.now() / 1000;`n    const endTime = parseFloat(market.endTime);`n    `n    if (market.status === 1) return "Resolved";`n    if (market.status === 2) return "Cancelled";`n    if (endTime < now) return "Ended";`n    return "Active";`n  };`n`n  if (isLoading) {`n    return (`n      <Card className="bg-gradient-to-br from-[#1A1F2C] to-[#151923] border-gray-800/50">`n        <CardHeader>`n          <CardTitle className="text-white">Positions</CardTitle>`n        </CardHeader>`n        <CardContent>`n          <div className="space-y-4">`n            {Array.from({ length: 3 }).map((_, i) => (`n              <div key={i} className="flex items-center space-x-4 p-4 border border-gray-700 rounded-lg">`n                <div className="h-4 w-24 bg-gray-700 animate-pulse rounded" />`n                <div className="h-4 w-16 bg-gray-700 animate-pulse rounded" />`n                <div className="h-4 w-20 bg-gray-700 animate-pulse rounded" />`n                <div className="h-4 w-16 bg-gray-700 animate-pulse rounded" />`n              </div>`n            ))}`n          </div>`n        </CardContent>`n      </Card>`n    );`n  }`n`n  return (`n    <Card className="bg-gradient-to-br from-[#1A1F2C] to-[#151923] border-gray-800/50">`n      <CardHeader>`n        <div className="flex items-center justify-between">`n          <CardTitle className="text-white">`n            Your Positions ({filteredPositions.length})`n          </CardTitle>`n          <div className="flex items-center space-x-2">`n            <Button`n              variant="outline"`n              size="sm"`n              onClick={handleRefresh}`n              disabled={isLoading}`n              className="border-gray-700 text-gray-300 hover:bg-[#1A1F2C] hover:text-white"`n            >`n              <RefreshCw className={`h-4 w-4 mr-2 ${isLoading ? "animate-spin" : ""}`} />`n              Refresh`n            </Button>`n            {!compact && (`n              <Button variant="outline" size="sm" asChild className="border-gray-700 text-gray-300 hover:bg-[#1A1F2C] hover:text-white">`n                <Link href="/dashboard/positions">`n                  View All`n                  <ExternalLink className="h-4 w-4 ml-2" />`n                </Link>`n              </Button>`n            )}`n          </div>`n        </div>`n`n        {/* Error Banner */}`n        {error && (`n          <div className="mt-4 p-3 bg-red-900/20 border border-red-500/30 rounded-lg">`n            <div className="flex items-center space-x-2 text-red-400">`n              <AlertTriangle className="h-4 w-4" />`n              <span className="text-sm">{error}</span>`n            </div>`n          </div>`n        )}`n`n        {/* Implementation Notice */}`n        <div className="mt-4 p-3 bg-yellow-900/20 border border-yellow-500/30 rounded-lg">`n          <div className="flex items-center space-x-2 text-yellow-400">`n            <AlertTriangle className="h-4 w-4" />`n            <div className="text-sm">`n              <p className="font-medium">Position Tracking Not Yet Implemented</p>`n              <p className="text-xs text-yellow-300 mt-1">`n                User position tracking will be available once implemented in the Credit Predict smart contract. `n                Currently showing live market data from the blockchain.`n              </p>`n            </div>`n          </div>`n        </div>`n`n        {/* Filters */}`n        {!compact && (`n          <div className="flex flex-col sm:flex-row gap-4 mt-4">`n            <div className="relative flex-1">`n              <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400" />`n              <Input`n                placeholder="Search positions..."`n                value={searchQuery}`n                onChange={(e) => setSearchQuery(e.target.value)}`n                className="pl-9 bg-[#0A0C14] border-gray-700 text-white placeholder:text-gray-400 focus:border-[#9b87f5]"`n              />`n            </div>`n            `n            <Select value={filterSide} onValueChange={(value: any) => setFilterSide(value)}>`n              <SelectTrigger className="w-full sm:w-32 bg-[#0A0C14] border-gray-700 text-white">`n                <SelectValue />`n              </SelectTrigger>`n              <SelectContent className="bg-[#0A0C14] border-gray-700">`n                <SelectItem value="all">All Sides</SelectItem>`n                <SelectItem value="optionA">Option A</SelectItem>`n                <SelectItem value="optionB">Option B</SelectItem>`n              </SelectContent>`n            </Select>`n`n            <Select value={sortBy} onValueChange={(value: any) => setSortBy(value)}>`n              <SelectTrigger className="w-full sm:w-40 bg-[#0A0C14] border-gray-700 text-white">`n                <SelectValue />`n              </SelectTrigger>`n              <SelectContent className="bg-[#0A0C14] border-gray-700">`n                <SelectItem value="pnl">Sort by P&L</SelectItem>`n                <SelectItem value="value">Sort by Value</SelectItem>`n                <SelectItem value="created">Sort by Date</SelectItem>`n                <SelectItem value="market">Sort by Market</SelectItem>`n              </SelectContent>`n            </Select>`n`n            <Button`n              variant="outline"`n              size="sm"`n              onClick={() => setSortOrder(sortOrder === "desc" ? "asc" : "desc")}`n              className="border-gray-700 text-gray-300 hover:bg-[#1A1F2C] hover:text-white"`n            >`n              <ArrowUpDown className="h-4 w-4" />`n            </Button>`n          </div>`n        )}`n`n        {/* Last Updated Info */}`n        <div className="mt-2 text-xs text-gray-400">`n          Data from Flow blockchain â€¢ Last updated: {new Date(lastRefresh).toLocaleTimeString()}`n        </div>`n      </CardHeader>`n`n      <CardContent className="p-0">`n        {filteredPositions.length === 0 ? (`n          <div className="text-center py-8">`n            <Target className="mx-auto h-12 w-12 text-gray-400 mb-4 opacity-50" />`n            <h3 className="text-lg font-medium text-white mb-2">No positions found</h3>`n            <p className="text-gray-400 mb-4">`n              {searchQuery `n                ? "Try adjusting your search criteria" `n                : positions.length === 0`n                  ? "Position tracking will be available once implemented in the smart contract"`n                  : "Start trading to see your positions here"`n              }`n            </p>`n            <Button `n              asChild `n              className="bg-gradient-to-r from-[#9b87f5] to-[#8b5cf6] hover:from-[#8b5cf6] hover:to-[#7c3aed] text-white"`n            >`n              <Link href="/markets">`n                Browse Markets`n              </Link>`n            </Button>`n          </div>`n        ) : (`n          <div className="divide-y divide-gray-800">`n            {filteredPositions.slice(0, compact ? 3 : undefined).map((position) => {`n              const market = markets.find(m => m.id === position.marketId?.toString());`n              const optionName = position.side === "optionA" `n                ? (market?.optionA || position.optionAName || "Option A")`n                : (market?.optionB || position.optionBName || "Option B");`n              `n              return (`n                <div key={position.id} className="p-4 hover:bg-gray-800/30 transition-colors">`n                  <div className="flex items-start justify-between">`n                    {/* Market Info */}`n                    <div className="flex-1 min-w-0">`n                      <div className="flex items-start space-x-3">`n                        <Badge `n                          variant={position.side === "optionA" ? "default" : "secondary"}`n                          className={`${`n                            position.side === "optionA" `n                              ? "bg-green-500/20 text-green-400 border-green-500/30"`n                              : "bg-blue-500/20 text-blue-400 border-blue-500/30"`n                          }`}`n                        >`n                          {optionName}`n                        </Badge>`n                        `n                        <div className="flex-1 min-w-0">`n                          <Link `n                            href={`/markets/${position.marketId}`}`n                            className="font-medium text-white hover:text-[#9b87f5] transition-colors line-clamp-1"`n                          >`n                            {market?.title || position.marketTitle || "Unknown Market"}`n                          </Link>`n                          `n                          <div className="flex items-center space-x-4 mt-1 text-sm text-gray-400">`n                            <span>{market?.category || position.marketCategory || "Unknown"}</span>`n                            <span>â€¢</span>`n                            <span>{formatShares(position.shares)} shares</span>`n                            <span>â€¢</span>`n                            <span>Avg: {(position.averagePrice * 100).toFixed(0)}Â¢</span>`n                          </div>`n                        </div>`n                      </div>`n`n                      {/* Market Status and Countdown */}`n                      {market && (`n                        <div className="mt-2 flex items-center space-x-4 text-xs">`n                          <div className="flex items-center space-x-1">`n                            <Calendar className="h-3 w-3" />`n                            <CountdownTimer endTime={parseInt(market.endTime) * 1000} compact />`n                          </div>`n                          <Badge variant="outline" className="border-gray-600 text-gray-300">`n                            {getMarketStatus(market)}`n                          </Badge>`n                        </div>`n                      )}`n                    </div>`n`n                    {/* Position Values */}`n                    <div className="text-right ml-4">`n                      <div className="space-y-1">`n                        <div className="flex items-center space-x-2">`n                          <span className="text-sm text-gray-400">Value:</span>`n                          <span className="font-medium text-white">{formatCurrency(position.currentValue)}</span>`n                        </div>`n                        `n                        <div className={`flex items-center space-x-1 ${getPnlColor(position.pnl)}`}>`n                          {getPnlIcon(position.pnl)}`n                          <span className="font-medium">`n                            {position.pnl >= 0 ? '+' : ''}{formatCurrency(position.pnl)}`n                          </span>`n                          <span className="text-xs">`n                            ({((position.pnl / position.totalCost) * 100).toFixed(1)}%)`n                          </span>`n                        </div>`n                      </div>`n`n                      {/* Actions */}`n                      <div className="mt-2 flex items-center space-x-1">`n                        <Button `n                          variant="ghost" `n                          size="sm" `n                          className="h-6 px-2 text-gray-400 hover:text-white hover:bg-gray-800"`n                        >`n                          <MoreHorizontal className="h-3 w-3" />`n                        </Button>`n                      </div>`n                    </div>`n                  </div>`n                </div>`n              );`n            })}`n          </div>`n        )}`n      </CardContent>`n`n      {/* Markets Available for Trading */}`n      {positions.length === 0 && markets.length > 0 && (`n        <CardContent className="pt-0">`n          <div className="border-t border-gray-800 pt-4">`n            <h4 className="text-sm font-medium text-white mb-3">Available Markets</h4>`n            <div className="space-y-2">`n              {markets.slice(0, 3).map((market) => (`n                <Link`n                  key={market.id}`n                  href={`/markets/${market.id}`}`n                  className="block p-3 border border-gray-700 rounded-lg hover:bg-gray-800/30 transition-colors"`n                >`n                  <div className="flex items-center justify-between">`n                    <div>`n                      <p className="text-sm font-medium text-white line-clamp-1">`n                        {market.title}`n                      </p>`n                      <div className="flex items-center space-x-2 mt-1 text-xs text-gray-400">`n                        <span>Pool: {parseFloat(market.totalPool).toFixed(2)} tCTC</span>`n                        <span>â€¢</span>`n                        <Badge variant="outline" className="border-gray-600 text-gray-300">`n                          {getMarketStatus(market)}`n                        </Badge>`n                      </div>`n                    </div>`n                    <ExternalLink className="h-4 w-4 text-gray-400" />`n                  </div>`n                </Link>`n              ))}`n            </div>`n          </div>`n        </CardContent>`n      )}`n    </Card>`n  );`n}